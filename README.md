# Generic SCION Kathara Lab

A Python tool to convert SCION topology configurations into Kathará lab format for network emulation and testing.

## Overview

This project provides a conversion script that takes SCION topology files generated by standard SCION tools and transforms them into a format suitable for running in [Kathará](https://www.kathara.org/), a lightweight network emulation platform.

## Directory Structure

```
.
├── convert_scion_topology.py    # Main conversion script
├── Dockerfile                   # Docker image definition
├── input_scion/                 # Input directory
│   └── gen/                     # Generated SCION topology
│       ├── ASff00_0_110/        # AS directories
│       ├── ASff00_0_111/
│       └── ...
└── KatharaLab/                  # Output directory (generated)
    ├── lab.conf                 # Kathara lab configuration
    ├── shared/                  # Shared directory (accessible from all containers)
    ├── as_110/                  # Node directory
    │   └── etc/
    │       └── scion/           # SCION configuration
    │           ├── br.toml
    │           ├── cs.toml
    │           ├── sd.toml
    │           ├── topology.json
    │           ├── certs/
    │           ├── crypto/
    │           └── keys/
    ├── as_110.startup           # Node startup script
    └── ...
```

## Prerequisites

- Python 3.6+
- Python packages:
  - `toml`
- Docker
- Kathara

Install Python dependencies:
```bash
pip install toml
```

## Quick Start

### 1. Build Docker Image

First, build the SCION Docker image for Kathara:

```bash
docker build -f Dockerfile -t kathara/scion-local .
```

### 2. Generate SCION Topology

**Note:** These steps are only required if you want to create your own custom topology from a `.topo` file. Otherwise, you can use the topology files already included in this repository, which will be valid until November 5th, 2026.

Clone the SCION repository:
```bash
git clone https://github.com/scionproto/scion
cd scion
```

**Important modifications required:**

#### a. Fix Certificate Validity
In `tools/topology/cert.py`, find the line containing `testcrypto` and change it to:
```python
self.pki('testcrypto', '-t', self.args.topo_config, '-o', self.args.output_dir, '--as-validity', '365d')
```

This makes sure that your certificates remain valid for a longer duration than 3 days, i.e. you do not need to regenerate
your topology frequently.

#### b. Remove IPv6 Underlay
In `topology/default.topo`, remove all lines containing:
```
underlay: UDP/IPv6
```
Since this lab only supports IPv4 for now.

#### c. Generate Topology
```bash
./scion.sh topology -c topology/default.topo
```

This will create the SCION topology in `gen/` directory.

### 3. Copy Generated Files

Copy the generated `gen/` directory to the project's `input_scion/` directory:
```bash
cp -r gen /path/to/input_scion/
```

### 4. Convert to Kathara Format

Run the conversion script:
```bash
python3 convert_scion_topology.py
```

### 5. Launch Kathara Lab

```bash
cd KatharaLab
kathara lstart
```

### 6. Stop Kathara Lab

```bash
cd KatharaLab
kathara lclean
```

## Conversion Process

The script performs the following operations:

### 1. AS Directory Mapping
- Detects all `ASff00_0_XXX` directories
- Maps them to `as_XXX` node directories
- Example: `ASff00_0_110` → `as_110`

### 2. Configuration File Processing

For each AS:

#### Border Router (br.toml)
- Removes metrics section
- Updates config directory to `/etc/scion/`
- Sets border router ID to `'br'`
- Updates API address with correct IP

#### Control Service (cs.toml)
- Removes metrics and tracing sections
- Updates config directory to `/etc/scion/`
- Updates database paths
- Updates API address

#### SCION Daemon (sd.toml)
- Removes metrics and tracing sections
- Updates config directory to `/etc/scion/`
- Updates database paths
- Updates Daemon and API addresses

#### Topology (topology.json)
- Removes test_dispatcher
- Updates all service addresses
- **Consolidates multiple border routers** into a single `'br'` entry
- **Assigns unique ports** for each interface link
- Handles multiple links between the same node pairs

### 3. Port Allocation

The script uses a `PortAllocator` class to manage port assignments:
- Ports start from 50000
- Each link between nodes gets a unique port
- Multiple links between the same pair of nodes increment sequentially
- Both sides of a connection use the same port number

### 4. Kathara Configuration

Generates:

#### lab.conf
- Lab metadata (description, version, author)
- Node definitions with network attachments
- Docker image specification (`kathara/scion-local`)

#### Startup Scripts (.startup)
- IP address configuration (10.0.0.X/24 and 192.168.0.X/24)
- SCION service startup commands:
  - `scion-dispatcher.service`
  - `scion-router.service`
  - `scion-control.service`
  - `scion-daemon.service`

## IP Address Scheme

- **External Network (eth0)**: `10.0.0.X/24` where X is the AS number
  - Example: AS 110 → `10.0.0.110`
  - Example: AS 111 → `10.0.0.111`

- **Internal Network (eth1)**: `192.168.0.X/24` where X is the AS number
  - Example: AS 110 → `192.168.0.110`
  - Example: AS 111 → `192.168.0.111`

## Port Assignment

- **Border Router Interfaces**: Starting from 50000, incrementing for each unique link
- **Border Router API**: Port 31442
- **Control Service API**: Port 31152
- **SCION Daemon**: Port 30255
- **SD API**: Port 30955

## Shared Files Between Containers

To share files between all containers, use the `KatharaLab/shared` directory. This directory is automatically mounted in all containers and can be used to exchange files or configuration data.

## Troubleshooting

### No AS directories found
- Ensure SCION topology is generated in `input_scion/gen/`
- Check that AS directories follow the `ASff00_0_XXX` naming convention

### Certificate validity issues
- Make sure you modified `cert.py` to set `--as-validity` to `365d`
- Without this change, certificates may expire quickly

### IPv6 issues
- Ensure all `underlay: UDP/IPv6` lines are removed from the topology file
- The current setup only supports IPv4

## Kathara Commands

- **Start lab**: `kathara lstart` (from KatharaLab directory)
- **Stop lab**: `kathara lclean` (from KatharaLab directory)
- **Connect to node**: `kathara connect as_110`
- **List running labs**: `kathara list`

## Script Output

The conversion script provides detailed output:
```
Found 3 AS directories:
  ASff00_0_110 => as_110
  ASff00_0_111 => as_111
  ASff00_0_112 => as_112

Processing ASff00_0_110 => as_110 (10.0.0.110)
  Copied certs/
  Copied crypto/
  Copied keys/
  Copied and renamed br1.toml => br.toml
  Updated br.toml configuration
  Copied and renamed cs1.toml => cs.toml
  Updated cs.toml configuration
  Copied sd.toml
  Updated sd.toml configuration
  Copied topology.json
  Updated topology.json configuration

✓ Reorganization complete!

Generating Kathara configuration files...
  Generated as_110.startup
  Generated as_111.startup
  Generated as_112.startup

✓ Generated lab.conf

✓ All done! Kathara lab is ready.
```
